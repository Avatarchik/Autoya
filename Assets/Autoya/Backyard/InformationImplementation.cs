using System;
using UnityEngine;
using AutoyaFramework.Information;
using System.Collections.Generic;
using MarkdownSharp;
using System.Linq;
using System.Collections;

/*
	information implementation.
*/
namespace AutoyaFramework {
	public partial class Autoya {
		/*
			public apis
		*/

		/**
			show information view which is generated by downloaded markdown data.
			then, if player touches button, link, or other items, something goes on.
		*/
		public static void Info_Show (string url, float windowWidth, float windowHeight, float anchorPos, Action<GameObject> onRootViewLoaded, Action<double> progress, Action loadDone, Action<int, string> loadFailed) {

			Debug.Assert(0 < windowWidth, "windowWidth is 0 or negative.");
			Debug.Assert(0 < windowHeight, "windowHeight is 0 or negative.");

			var http = new Connections.HTTP.HTTPConnection();

			var view = new ViewBox(windowWidth, windowHeight, anchorPos);
			
			Action<IEnumerator> executor = iEnum => {
				autoya.mainthreadDispatcher.Commit(iEnum);
			};

			var cor = http.Get(
				Guid.NewGuid().ToString(),
				new Dictionary<string, string>(),
				url,
				(conId, code, responseHeaders, html) => {
					var v = new ViewGenerator(executor);
					var root = v.GenerateViewFromSource(
						html, 
						new ViewBox(windowWidth, windowHeight, 0), //anchorPos
						progress, 
						loadDone
					);

					onRootViewLoaded(root);
				},
				(conId, code, reason, responseHeaders) => {
					loadFailed(code, reason);
				},
				5.0
			);

			autoya.mainthreadDispatcher.Commit(cor);
		}
	}
}